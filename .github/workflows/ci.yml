name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: test (${{ matrix.rust }}, ${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Stable Rust - all k8s-openapi versions
          - rust: stable
            features: v1_30
          - rust: stable
            features: v1_31
          - rust: stable
            features: v1_32
          - rust: stable
            features: v1_33
          # Stable Rust - all k8s-openapi versions with validation
          - rust: stable
            features: v1_30,validation
          - rust: stable
            features: v1_31,validation
          - rust: stable
            features: v1_32,validation
          - rust: stable
            features: v1_33,validation
          # Nightly Rust - v1_32 only
          - rust: nightly
            features: v1_32
          - rust: nightly
            features: v1_32,validation
    steps:
      - uses: actions/checkout@v5

      - name: install rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ubuntu-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-registry-

      - name: cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ubuntu-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-index-

      - name: cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ubuntu-${{ matrix.rust }}-${{ matrix.features }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-${{ matrix.rust }}-${{ matrix.features }}-cargo-build-target-

      - name: check
        run: cargo check --all-targets --no-default-features --features ${{ matrix.features }}

      - name: run tests
        run: cargo test --verbose --no-default-features --features ${{ matrix.features }}

      - name: run doc tests
        run: cargo test --doc --no-default-features --features ${{ matrix.features }}

  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: install rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ubuntu-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-registry-

      - name: cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ubuntu-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-index-

      - name: cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ubuntu-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-build-target-

      - name: check formatting
        run: cargo fmt -- --check

      - name: run clippy (default features)
        run: cargo clippy --all-targets -- -D warnings

  coverage:
    name: code coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: install rust
        uses: dtolnay/rust-toolchain@stable

      - name: install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: generate coverage (with validation)
        run: cargo tarpaulin --verbose --no-default-features --features v1_32,validation --workspace --timeout 120 --out xml

      - name: upload coverage to codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./cobertura.xml
          fail_ci_if_error: false

  security:
    name: security audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: install rust
        uses: dtolnay/rust-toolchain@stable

      - name: run cargo audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  docs:
    name: documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: install rust
        uses: dtolnay/rust-toolchain@stable

      - name: cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ubuntu-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-registry-

      - name: cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ubuntu-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ubuntu-cargo-index-

      - name: check documentation (default features)
        run: cargo doc --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: -D warnings
