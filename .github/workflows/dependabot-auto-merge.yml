name: dependabot auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ci-check
        id: ci-check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR number
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            # For workflow_run events, get PR from the head branch
            PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found"
            exit 0
          fi

          # Check if all checks have passed
          gh pr checks "$PR_NUMBER" --repo "${{ github.repository }}" --watch --interval 30

          # Get PR details
          PR_DATA=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json title,mergeable,mergeStateStatus)
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')

          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "merge_state=$MERGE_STATE" >> $GITHUB_OUTPUT

      - name: auto-merge
        if: steps.ci-check.outputs.mergeable == 'MERGEABLE' && steps.ci-check.outputs.merge_state == 'CLEAN'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.ci-check.outputs.pr_number }}"
          PR_TITLE="${{ steps.ci-check.outputs.pr_title }}"

          # Merge the PR using the title as commit message
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --squash \
            --subject "$PR_TITLE" \
            --auto

          echo "âœ… Auto-merged PR #$PR_NUMBER: $PR_TITLE"
